<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>vueç»„ä»¶</title>
    <script src="../js/vue-2.4.0.js"></script>
    <style>

    </style>
</head>

<body>

    <div id="app1">
        <input type="text">
        <span></span>
        <hr>
        haha:<span class="haha"></span>
    </div>

    <script>
        function defineReactive(obj, key, val) {
            // é€’å½’å­å±æ€§
            observe(val)
            let dp = new Dep()
            console.log("ğŸš€ ~ defineReactive ~ dp", dp)
            Object.defineProperty(obj, key, {
                enumerable: true,
                configurable: true,
                get: function reactiveGetter() {
                    console.log('get value')
                    // å°† Watcher æ·»åŠ åˆ°è®¢é˜…
                    if (Dep.target) {
                        dp.addSub(Dep.target)
                    }
                    return val
                },
                set: function reactiveSetter(newVal) {
                    console.log('change value')
                    val = newVal
                    // æ‰§è¡Œ watcher çš„ update æ–¹æ³•
                    dp.notify()
                }
            })
        }
        function observe(obj) {
            // åˆ¤æ–­ç±»å‹
            if (!obj || typeof obj !== 'object') {
                return
            }
            Object.keys(obj).forEach(key => {
                defineReactive(obj, key, obj[key])
            })
        }

        // é€šè¿‡ Dep è§£è€¦
        class Dep {
            constructor() {
                this.subs = []
            }
            addSub(sub) {
                // sub æ˜¯ Watcher å®ä¾‹
                this.subs.push(sub)
            }
            notify() {
                this.subs.forEach(sub => {
                    sub.update()
                })
            }
        }
        // å…¨å±€å±æ€§ï¼Œé€šè¿‡è¯¥å±æ€§é…ç½® Watcher
        Dep.target = null

        
        class Watcher {
            constructor(obj, key, cb) {
                // å°† Dep.target æŒ‡å‘è‡ªå·±
                // ç„¶åè§¦å‘å±æ€§çš„ getter æ·»åŠ ç›‘å¬
                // æœ€åå°† Dep.target ç½®ç©º
                Dep.target = this
                this.cb = cb
                this.obj = obj
                this.key = key
                this.value = obj[key]
                Dep.target = null
                // this.update(); // å¦‚æœä¸‹é¢æ²¡æœ‰ç›´æ¥æŠŠå€¼æ¸²æŸ“åˆ°é¡µé¢ï¼Œè¿™é‡Œå°±å¯ä»¥ç«‹å³è§¦å‘ä¸€æ¬¡updateï¼Œå¼ºåˆ¶æ¸²æŸ“
            }
            update() {
                // è·å¾—æ–°å€¼
                this.value = this.obj[this.key]
                // è°ƒç”¨ update æ–¹æ³•æ›´æ–° Dom
                this.cb(this.value)
            }
        }
        var data = { name: 'yck', haha: "1234", obj: { a: 1 } }
        document.querySelector('input').addEventListener("input", function () {
            data.name = this.value
        })

        observe(data)

        function update(value) {
            document.querySelector('input').value = value;
            document.querySelector('span').innerText = value;
        }
        function update2(value) {
            document.querySelector('.haha').innerText = value;
        }

        // æ¨¡æ‹Ÿè§£æåˆ° `{{name}}` è§¦å‘çš„æ“ä½œ
        new Watcher(data, 'name', update);
        new Watcher(data.obj, 'a', update2);
        // update Dom innerText
        data.name = 'yyy'
    </script>
</body>

</html>